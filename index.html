<html>
  {{> head }}

  <body class="center">
    <main>
      <header>
        <h1 data-label="user">
          {{title}}
        </h1>
        <h3>
          <a
            href="https://open.spotify.com/user/{{title}}"
            data-label="open-spotify"
            >https://open.spotify.com/user/{{title}}</a
          >
        </h3>
      </header>

      <div id="items"></div>
      <pre id="json"></pre>
    </main>

    <script>
      const url = "/api/user/{{title}}";

      localStorage.getItem(url);

      function getLocalData(key) {
        return JSON.parse(localStorage.getItem(key));
      }

      function $get(query) {
        return document.getElementById(query);
      }

      function fillPage(data) {
        const div = Object.assign(document.createElement("a"), {
          href: url,
          textContent: url
        });

        data.items.forEach(e => {
          const item = Object.assign(document.createElement("div"), {
            textContent: e.name,
            className: "card"
          });
          const description = Object.assign(document.createElement("div"), {
            textContent: e.description
          });

          item.appendChild(description);

          $get("items").appendChild(item);
        });

        document.body.appendChild(div);
      }

      function dataManager(userUrl, cb) {
        var dat = getLocalData(userUrl);

        if (!localStorage.getItem(userUrl) && dat) {
          fetch(userUrl)
            .then(response => response.json())
            .then(data => {
              dat = data.body;
              console.log("fetched", data);
              localStorage.setItem(
                userUrl,
                JSON.stringify({
                  ...data.body,
                  fetched: new Date().toLocaleString()
                })
              );
            });
        }

        cb(dat);
      }

      dataManager(url, fillPage);
    </script>
  </body>
</html>
