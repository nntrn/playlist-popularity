<html>
  {{> head }}
  <body class="center">
    <header>
      <h1 id="">
        {{title}}
      </h1>
    </header>

    <main>
      <pre>{{json}}</pre>
    </main>

    <script>
      const url = "/api/user/{{title}}";

      localStorage.getItem(url);

      function getLocalData(key) {
        return JSON.parse(localStorage.getItem(key));
      }

      function fillPage(data) {
        const div = Object.assign(document.createElement("div"), {
          textContent: data.href
        });

        document.body.appendChild(div);
      }

      function dataManager(userUrl, cb) {
        var dat = getLocalData(userUrl);

        if (!localStorage.getItem(userUrl) && dat) {
          fetch(userUrl)
            .then(response => response.json())
            .then(data => {
            
              dat = data.body;
              console.log('fetched',data);
              localStorage.setItem(userUrl, JSON.stringify({
                ...data.body,
                fetched: (new Date()).toLocaleString()
              }));
            });
        }

        cb(dat);
      }

      dataManager(url, fillPage);
    </script>
  </body>
</html>
